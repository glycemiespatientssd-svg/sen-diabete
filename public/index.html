<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEN'Diab√®te - Plateforme de Suivi Glyc√©mique</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c7fb8;
            --secondary-color: #7fcdbb;
            --success-color: #2ca25f;
            --warning-color: #fec44f;
            --danger-color: #de2d26;
            --light-color: #f0f9ff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        
        .navbar-brand img {
            height: 40px;
            margin-right: 10px;
        }
        
        .sidebar {
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            min-height: calc(100vh - 56px);
        }
        
        .sidebar .nav-link {
            color: #555;
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: var(--light-color);
            color: var(--primary-color);
        }
        
        .card {
            border: none;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }
        
        .status-badge {
            padding: 0.35rem 0.65rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-hypo { background-color: rgba(222, 45, 38, 0.1); color: var(--danger-color); }
        .status-normal { background-color: rgba(44, 162, 95, 0.1); color: var(--success-color); }
        .status-hyper { background-color: rgba(254, 196, 79, 0.1); color: #e68a00; }
        .status-severe { background-color: rgba(222, 45, 38, 0.2); color: var(--danger-color); font-weight: 700; }
        
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(44, 127, 184, 0.05);
        }
        
        .license-info {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="https://i.postimg.cc/pThbptsh/Logo-V2.png" alt="SEN'Diab√®te">
                SEN'Diab√®te
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>D√©connexion
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-2 col-md-3 p-0">
                <div class="sidebar p-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                                <i class="fas fa-home"></i> Tableau de bord
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('upload')">
                                <i class="fas fa-upload"></i> Upload photos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('patients')">
                                <i class="fas fa-table"></i> Donn√©es patients
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#licenseModal">
                                <i class="fas fa-key"></i> Gestion licence
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="text-center mb-2">Votre solde photos</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-primary" id="photoProgress" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span id="photosUsed">0</span>
                            <span id="photosTotal">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-10 col-md-9 p-4">
                <!-- Section Tableau de bord -->
                <div id="dashboardSection">
                    <div class="license-info">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-1" id="licenseTypeDisplay">Aucune licence active</h5>
                                <p class="mb-2" id="licenseDetails">Souscrivez √† une licence pour commencer</p>
                                <div class="progress bg-white bg-opacity-50">
                                    <div class="progress-bar bg-white" id="licenseProgressBar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#licenseModal">
                                    <i class="fas fa-bolt me-1"></i>Activer licence
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="h4 mb-0">Tableau de bord glyc√©mique</h2>
                        <button class="btn btn-primary" onclick="showSection('upload')">
                            <i class="fas fa-upload me-2"></i>Uploader des photos
                        </button>
                    </div>

                    <div class="row mb-4">
                        <div class="col-xl-2 col-md-4 col-sm-6">
                            <div class="card text-center p-3">
                                <div class="h3 text-primary mb-0" id="totalAnalyzed">0</div>
                                <div class="text-muted">Photos analys√©es</div>
                            </div>
                        </div>
                        <div class="col-xl-2 col-md-4 col-sm-6">
                            <div class="card text-center p-3">
                                <div class="h3 text-success mb-0" id="normalCount">0</div>
                                <div class="text-muted">Normales</div>
                            </div>
                        </div>
                        <div class="col-xl-2 col-md-4 col-sm-6">
                            <div class="card text-center p-3">
                                <div class="h3 text-warning mb-0" id="hyperCount">0</div>
                                <div class="text-muted">Hyperglyc√©mies</div>
                            </div>
                        </div>
                        <div class="col-xl-2 col-md-4 col-sm-6">
                            <div class="card text-center p-3">
                                <div class="h3 text-danger mb-0" id="hypoCount">0</div>
                                <div class="text-muted">Hypoglyc√©mies</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-history me-2"></i>Derni√®res analyses
                        </div>
                        <div class="card-body">
                            <div id="recentAnalyses">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <h5>Aucune analyse</h5>
                                    <p>Commencez par uploader vos premi√®res photos glyc√©miques</p>
                                    <button class="btn btn-primary mt-2" onclick="showSection('upload')">
                                        <i class="fas fa-upload me-2"></i>Uploader des photos
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Upload -->
                <div id="uploadSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="h4 mb-0">Uploader des photos glyc√©miques</h2>
                        <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                            <i class="fas fa-arrow-left me-2"></i>Retour
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-cloud-upload-alt me-2"></i>Upload de photos
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-file-image fa-3x text-muted mb-3"></i>
                                <h5>Glissez-d√©posez vos fichiers ici</h5>
                                <p class="text-muted">ou</p>
                                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open me-2"></i>Parcourir les fichiers
                                </button>
                                <p class="mt-2 small text-muted">Formats support√©s: JPG, PNG, JPEG (max 5MB)</p>
                                <input type="file" id="fileInput" multiple accept="image/jpeg,image/png,image/jpg" style="display: none;">
                            </div>
                            
                            <div class="mt-4" id="selectedFilesContainer" style="display: none;">
                                <h6>Photos s√©lectionn√©es</h6>
                                <div id="selectedFiles" class="mt-2"></div>
                            </div>

                            <div id="analysisProgress" style="display: none;">
                                <div class="card bg-light mt-4">
                                    <div class="card-body text-center">
                                        <div class="loading-spinner mb-3"></div>
                                        <h5>Analyse en cours...</h5>
                                        <p id="progressText">Traitement de l'image avec IA</p>
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="button" class="btn btn-secondary" onclick="clearSelection()">
                                <i class="fas fa-times me-2"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-primary" onclick="processUpload()" id="analyzeButton">
                                <i class="fas fa-bolt me-2"></i>Analyser les photos
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section Patients -->
                <div id="patientsSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="h4 mb-0">Donn√©es des patients</h2>
                        <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                            <i class="fas fa-arrow-left me-2"></i>Retour
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-table me-2"></i>Historique des analyses
                        </div>
                        <div class="card-body">
                            <div id="patientsTable">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-users fa-3x mb-3"></i>
                                    <h5>Aucune donn√©e patient</h5>
                                    <p>Les analyses apparaitront ici apr√®s le traitement des photos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestion Licence -->
    <div class="modal fade" id="licenseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestion de votre licence</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-crown me-2"></i>Votre licence actuelle
                        </div>
                        <div class="card-body">
                            <div id="currentLicenseInfo">
                                <p class="text-center text-muted py-3">Aucune licence active</p>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3">Choisir votre pack</h5>
                    <div class="row" id="packagesContainer">
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <h5 class="card-title">Basique</h5>
                                    <h3 class="text-primary">5.000 FCFA</h3>
                                    <p class="text-muted">20 photos</p>
                                    <button class="btn btn-outline-primary" onclick="selectPackage('basic')">
                                        Choisir
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 text-center border-primary">
                                <div class="card-body">
                                    <span class="badge bg-warning">Populaire</span>
                                    <h5 class="card-title">Professionnel</h5>
                                    <h3 class="text-primary">20.000 FCFA</h3>
                                    <p class="text-muted">250 photos</p>
                                    <button class="btn btn-primary" onclick="selectPackage('pro')">
                                        Choisir
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <h5 class="card-title">Illimit√©</h5>
                                    <h3 class="text-primary">250.000 FCFA</h3>
                                    <p class="text-muted">Photos illimit√©es</p>
                                    <button class="btn btn-outline-primary" onclick="selectPackage('enterprise')">
                                        Choisir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
       // V√©rification STRICTE de l'authentification au chargement
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîê V√©rification authentification...');
    
    // FORCER la v√©rification
    const appState = localStorage.getItem('senDiabeteState');
    const currentUserEmail = localStorage.getItem('currentUserEmail');
    
    console.log('üìÅ √âtat application:', appState ? 'Pr√©sent' : 'Absent');
    console.log('üìß Email utilisateur:', currentUserEmail);
    
    // SI PAS DE SESSION ‚Üí REDIRECTION IMM√âDIATE
    if (!appState || !currentUserEmail) {
        console.log('üö´ Session invalide - Redirection IMM√âDIATE vers login');
        // Nettoyer et rediriger
        localStorage.removeItem('senDiabeteState');
        localStorage.removeItem('currentUserEmail');
        // REDIRECTION FORC√âE
        window.location.replace('/login.html');
        return;
    }
    
    try {
        const state = JSON.parse(appState);
        
        // V√©rifier la coh√©rence email
        if (state.user.email !== currentUserEmail) {
            console.log('üö´ Email incoh√©rent - Redirection');
            localStorage.removeItem('senDiabeteState');
            localStorage.removeItem('currentUserEmail');
            window.location.replace('/login.html');
            return;
        }
        
        // V√©rifier licence
        const expiryDate = new Date(state.license.expiryDate);
        if (expiryDate < new Date()) {
            alert('Votre licence a expir√©. Contactez l\'administrateur.');
            localStorage.removeItem('senDiabeteState');
            localStorage.removeItem('currentUserEmail');
            window.location.replace('/login.html');
            return;
        }
        
        console.log('‚úÖ Authentification VALIDE - Chargement application');
        loadAppState();
        setupEventListeners();
        
    } catch (error) {
        console.error('‚ùå Erreur chargement √©tat:', error);
        localStorage.removeItem('senDiabeteState');
        localStorage.removeItem('currentUserEmail');
        window.location.replace('/login.html');
    }
});

        const LICENSE_PACKAGES = {
            'basic': { photos: 20, price: 5000 },
            'pro': { photos: 250, price: 20000 },
            'enterprise': { photos: 9999, price: 250000 }
        };

        let appState = {
            user: { name: 'M√©decin', email: '' },
            license: { type: 'none', photosUsed: 0, photosTotal: 0, expiryDate: null },
            analyses: []
        };

        function loadAppState() {
            const saved = localStorage.getItem('senDiabeteState');
            if (saved) {
                appState = JSON.parse(saved);
            }
            updateUI();
        }

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag & drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary-color)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#dee2e6';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#dee2e6';
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect();
                }
            });
        }

        function handleFileSelect() {
            const files = document.getElementById('fileInput').files;
            const container = document.getElementById('selectedFiles');
            const filesContainer = document.getElementById('selectedFilesContainer');
            
            if (files.length === 0) {
                filesContainer.style.display = 'none';
                return;
            }
            
            let html = '';
            for (let i = 0; i < files.length; i++) {
                html += `
                    <div class="d-flex align-items-center p-2 border rounded mb-2">
                        <i class="fas fa-file-image text-muted me-3"></i>
                        <div class="flex-grow-1">
                            <div class="small">${files[i].name}</div>
                            <div class="text-muted small">${(files[i].size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
            filesContainer.style.display = 'block';
        }

        function clearSelection() {
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedFilesContainer').style.display = 'none';
            document.getElementById('analysisProgress').style.display = 'none';
        }

      async function processUpload() {
    const files = document.getElementById('fileInput').files;
    if (files.length === 0) {
        alert('Veuillez s√©lectionner au moins une photo');
        return;
    }
    
    if (appState.license.type === 'none') {
        alert('Veuillez souscrire √† une licence pour analyser des photos');
        return;
    }
    
    const remaining = appState.license.photosTotal - appState.license.photosUsed;
    if (files.length > remaining && appState.license.type !== 'enterprise') {
        alert(`Vous n'avez que ${remaining} photo(s) restante(s).`);
        return;
    }
    
    const success = await analyzePhotos(files);
    
    if (!success) {
        alert('L\'analyse a √©chou√©. V√©rifiez votre connexion et r√©essayez.');
    }
}

async function analyzePhotos(files) {
    const analyzeButton = document.getElementById('analyzeButton');
    const originalText = analyzeButton.innerHTML;
    
    document.getElementById('analysisProgress').style.display = 'block';
    analyzeButton.disabled = true;
    analyzeButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyse...';
    
    let allSuccess = true;
    let processedCount = 0;
    
    try {
        for (let i = 0; i < files.length; i++) {
            document.getElementById('progressText').textContent = `Traitement ${i + 1}/${files.length}`;
            
            const base64Image = await toBase64(files[i]);
            const result = await analyzeWithAI(base64Image);
            
            if (result.success && result.numericValue !== null) {
                const analysis = {
                    id: Date.now(),
                    patientName: 'Patient',
                    date: new Date().toLocaleString('fr-FR'),
                    value: `${result.numericValue} mg/dL`,
                    status: result.status,
                    fileName: files[i].name
                };
                appState.analyses.unshift(analysis);
                
                if (appState.license.type !== 'enterprise') {
                    appState.license.photosUsed++;
                }
                processedCount++;
            } else {
                console.error('‚ùå Analyse √©chou√©e pour:', files[i].name);
                allSuccess = false;
            }
        }
        
        if (processedCount > 0) {
            saveState();
            updateUI();
            showSection('dashboard');
            alert(`Analyse termin√©e ! ${processedCount}/${files.length} photo(s) analys√©e(s) avec succ√®s.`);
        } else {
            alert('Aucune photo n\'a pu √™tre analys√©e. V√©rifiez la qualit√© des images.');
        }
        
        clearSelection();
        return allSuccess;
        
    } catch (error) {
        console.error('Erreur globale analyse:', error);
        alert('Erreur lors de l\'analyse des photos.');
        return false;
    } finally {
        analyzeButton.innerHTML = originalText;
        analyzeButton.disabled = false;
        document.getElementById('analysisProgress').style.display = 'none';
    }
}

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function analyzeWithAI(base64Image) {
    try {
        console.log('üîç Appel API analyse glyc√©mie...');
        
        const response = await fetch('/analyze-glycemia', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ imageData: base64Image })
        });
        
        console.log('üì° Statut r√©ponse:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Erreur serveur:', response.status, errorText);
            throw new Error(`Erreur serveur: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ R√©ponse API analyse:', result);
        
        if (!result.success) {
            console.error('‚ùå Erreur dans la r√©ponse:', result.error);
            throw new Error(result.error || 'Erreur analyse');
        }
        
        return result;
        
    } catch (error) {
        console.error('üí• Erreur critique analyse:', error);
        
        // Montrer l'erreur √† l'utilisateur
        alert(`Erreur analyse: ${error.message}\n\nV√©rifiez votre connexion et r√©essayez.`);
        
        // NE PAS utiliser la simulation - forcer l'√©chec
        return {
            success: false,
            error: error.message,
            status: 'error',
            numericValue: null
        };
    }
}

        function updateUI() {
            // Licence
            const progress = appState.license.photosTotal > 0 ? 
                (appState.license.photosUsed / appState.license.photosTotal) * 100 : 0;
            
            document.getElementById('photosUsed').textContent = appState.license.photosUsed;
            document.getElementById('photosTotal').textContent = appState.license.photosTotal;
            document.getElementById('photoProgress').style.width = `${progress}%`;
            document.getElementById('licenseProgressBar').style.width = `${progress}%`;
            
            document.getElementById('licenseTypeDisplay').textContent = 
                appState.license.type === 'none' ? 'Aucune licence active' : 'Licence Active';
            
            document.getElementById('licenseDetails').textContent = 
                appState.license.type === 'none' ? 'Souscrivez √† une licence' : 
                `${appState.license.photosUsed}/${appState.license.photosTotal} photos utilis√©es`;
            
            // Statistiques
            const analyses = appState.analyses;
            document.getElementById('totalAnalyzed').textContent = analyses.length;
            document.getElementById('normalCount').textContent = analyses.filter(a => a.status === 'normal').length;
            document.getElementById('hyperCount').textContent = analyses.filter(a => a.status === 'hyper').length;
            document.getElementById('hypoCount').textContent = analyses.filter(a => a.status === 'hypo').length;
            
            updateRecentAnalyses();
            updatePatientsTable();
            updateLicenseModal();
        }

        function updateRecentAnalyses() {
            const container = document.getElementById('recentAnalyses');
            const recent = appState.analyses.slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <h5>Aucune analyse</h5>
                        <p>Commencez par uploader vos premi√®res photos glyc√©miques</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table"><thead><tr><th>Patient</th><th>Date</th><th>Valeur</th><th>Statut</th></tr></thead><tbody>';
            recent.forEach(analysis => {
                html += `
                    <tr>
                        <td>${analysis.patientName}</td>
                        <td>${analysis.date}</td>
                        <td>${analysis.value}</td>
                        <td><span class="status-badge status-${analysis.status}">${getStatusText(analysis.status)}</span></td>
                    </tr>
                `;
            });
            container.innerHTML = html + '</tbody></table></div>';
        }

        function updatePatientsTable() {
            const container = document.getElementById('patientsTable');
            
            if (appState.analyses.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <h5>Aucune donn√©e patient</h5>
                        <p>Les analyses apparaitront ici apr√®s le traitement des photos</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table"><thead><tr><th>Patient</th><th>Date</th><th>Valeur</th><th>Statut</th></tr></thead><tbody>';
            appState.analyses.forEach(analysis => {
                html += `
                    <tr>
                        <td>${analysis.patientName}</td>
                        <td>${analysis.date}</td>
                        <td>${analysis.value}</td>
                        <td><span class="status-badge status-${analysis.status}">${getStatusText(analysis.status)}</span></td>
                    </tr>
                `;
            });
            container.innerHTML = html + '</tbody></table></div>';
        }

        function updateLicenseModal() {
            const container = document.getElementById('currentLicenseInfo');
            
            if (appState.license.type === 'none') {
                container.innerHTML = '<p class="text-center text-muted py-3">Aucune licence active</p>';
                return;
            }
            
            const progress = (appState.license.photosUsed / appState.license.photosTotal) * 100;
            const daysRemaining = appState.license.expiryDate ? 
                Math.ceil((new Date(appState.license.expiryDate) - new Date()) / (1000 * 60 * 60 * 24)) : 0;
            
            container.innerHTML = `
                <div class="row text-center">
                    <div class="col-md-6">
                        <p><strong>Type:</strong> ${getLicenseTypeName(appState.license.type)}</p>
                        <p><strong>Photos:</strong> ${appState.license.photosUsed}/${appState.license.photosTotal}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Expiration:</strong> ${appState.license.expiryDate ? new Date(appState.license.expiryDate).toLocaleDateString('fr-FR') : 'N/A'}</p>
                        <p><strong>Jours restants:</strong> ${daysRemaining}</p>
                    </div>
                </div>
                <div class="progress mt-3">
                    <div class="progress-bar" style="width: ${progress}%">${Math.round(progress)}%</div>
                </div>
            `;
        }

        function selectPackage(packageId) {
            const packageInfo = LICENSE_PACKAGES[packageId];
            const expiryDate = new Date();
            expiryDate.setFullYear(expiryDate.getFullYear() + 1);
            
            appState.license = {
                type: packageId,
                photosUsed: 0,
                photosTotal: packageInfo.photos,
                expiryDate: expiryDate.toISOString()
            };
            
            saveState();
            updateUI();
            
            bootstrap.Modal.getInstance(document.getElementById('licenseModal')).hide();
            alert(`Licence ${getLicenseTypeName(packageId)} activ√©e !`);
        }

        function getLicenseTypeName(type) {
            const names = { 'basic': 'Basique', 'pro': 'Professionnel', 'enterprise': 'Illimit√©' };
            return names[type] || 'Aucune';
        }

        function getStatusText(status) {
            const texts = { 'normal': 'Normal', 'hyper': 'Hyper', 'hypo': 'Hypo' };
            return texts[status] || 'Inconnu';
        }

        function showSection(sectionName) {
            document.querySelectorAll('[id$="Section"]').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionName + 'Section').style.display = 'block';
        }

        function saveState() {
            localStorage.setItem('senDiabeteState', JSON.stringify(appState));
        }

        function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                localStorage.removeItem('senDiabeteState');
                localStorage.removeItem('currentUserEmail');
                window.location.href = '/login.html';
            }
        }
    </script>
</body>
</html>
